<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionAwareHadoopPublisher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">techtest-maven</a> &gt; <a href="index.source.html" class="el_package">com.db.dataplatform.techtest.server.component.impl.hadoop</a> &gt; <span class="el_source">TransactionAwareHadoopPublisher.java</span></div><h1>TransactionAwareHadoopPublisher.java</h1><pre class="source lang-java linenums">package com.db.dataplatform.techtest.server.component.impl.hadoop;

import com.db.dataplatform.techtest.server.api.model.DataEnvelope;
import com.db.dataplatform.techtest.server.component.impl.SaveAndPublishedStatus;
import com.db.dataplatform.techtest.server.exception.HadoopClientException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.retry.ExhaustedRetryException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.event.TransactionPhase;
import org.springframework.transaction.event.TransactionalEventListener;

import static com.db.dataplatform.techtest.server.component.impl.SaveAndPublishedStatus.SaveAndPublishStatus.*;

<span class="fc" id="L16">@Slf4j</span>
@Service
<span class="fc" id="L18">@RequiredArgsConstructor</span>
public class TransactionAwareHadoopPublisher {

    private final HadoopWithCircuitBreakerAndRetryPublisher publisher;

    /**
     * Listens for committed database create transactions
     * Will be called after teh database transaction has committed but before the @Transactional method has returned
     * Publishes the data to hadoop
     * This is done as hadoop publishing can take a long time and we don't want to keep the db locked
     * This publishes to hadoop using a service that will retry several times
     * If the publish fails after repeated times we log the error
     * In practice it would better to use a persistent message queue to publish to hadoop - and publish within the transaction
     * @param data - the event data
     */
    @EventListener(SaveAndPublishedStatus.class)
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void onDataBlockCreate(SaveAndPublishedStatus&lt;DataEnvelope&gt; data)  {
        try{
<span class="fc" id="L37">            publisher.publishWithRetry(data.getEntity());</span>
<span class="fc" id="L38">            data.setStatus(SAVED_AND_PUBLISHED);</span>
<span class="fc" id="L39">        }catch( HadoopClientException | ExhaustedRetryException ex ){</span>
<span class="fc" id="L40">            log.error(&quot;Hadoop publishing failed&quot;,ex);</span>
<span class="fc" id="L41">            data.setStatus(SAVED_NOT_PUBLISHED);</span>

            /*
             At present if the hadoop service is unavailable or repeatedly fails
             this implementation will discard the hadoop update - but ensure the data is saved in the db
             if all data must get to hadoop then some additional state will be required here
             to store the failed hadoop updates
             best done by replacing with a message queue
             but could be done using the database
             and adding necessary recovery code either realtime or batch based to feed the missing data to hadoop
            */

<span class="fc" id="L53">        }</span>
<span class="fc" id="L54">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>